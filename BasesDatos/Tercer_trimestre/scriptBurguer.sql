CREATE TABLE PRODUCTO (
Codigo varchar2(3) PRIMARY KEY,
Nombre varchar2(50) UNIQUE,
Precio decimal(6,2)
);


CREATE TABLE EMPLEADO (
DNI varchar2(9) PRIMARY KEY,
Nombre varchar2(50),
Nss varchar2(11),
Turno varchar2(10) check (Turno in ('mañana','tarde','noche')),
Salario decimal(6,2)
);


CREATE TABLE REPARTIDOR (
DNI varchar2(9) PRIMARY KEY,
Nombre varchar2(50),
Turno varchar2(10) check (Turno in ('mañana','tarde','noche')),
Incentivo decimal(6,2)
);


CREATE TABLE PEDIDO (
Numero varchar2(4) PRIMARY KEY,
Importe decimal(6,2),
DNI_ETM varchar2(9),
DNI_EP varchar2(9),
DNI_R varchar2(9),
Hora_tm timestamp,
Hora_pre timestamp,
Hora_rep timestamp,
CONSTRAINT Pe_dniETM_FK FOREIGN KEY (DNI_ETM) REFERENCES EMPLEADO(DNI) ON DELETE CASCADE,
CONSTRAINT Pe_dniEP_FK FOREIGN KEY (DNI_EP) REFERENCES EMPLEADO(DNI) ON DELETE CASCADE,
CONSTRAINT Pe_dniR_FK FOREIGN KEY (DNI_R) REFERENCES REPARTIDOR(DNI) ON DELETE CASCADE
);


CREATE TABLE esta_compuesto (
Codigo_P varchar2(3),
Codigo_P_compuesto varchar2(3),
CONSTRAINT EC_PK PRIMARY KEY (Codigo_P,Codigo_P_compuesto),
CONSTRAINT  EC_coP_FK FOREIGN KEY (Codigo_P) REFERENCES PRODUCTO(Codigo) ON DELETE CASCADE,
CONSTRAINT  EC_coPC_FK FOREIGN KEY (Codigo_P_compuesto) REFERENCES PRODUCTO(Codigo) ON DELETE CASCADE
);

CREATE TABLE consta(
Codigo_Pr varchar2(3),
Numero_P varchar2(4),
cantidad number(2),
CONSTRAINT CO_PK PRIMARY KEY (Codigo_Pr,Numero_P),
CONSTRAINT  CO_coP_FK FOREIGN KEY (Codigo_Pr) REFERENCES PRODUCTO(Codigo) ON DELETE CASCADE,
CONSTRAINT  CO_nuP_FK FOREIGN KEY (Numero_P) REFERENCES PEDIDO(Numero) ON DELETE CASCADE
);

/* VALORES EN TABLA PRODUCTO */
INSERT INTO PRODUCTO VALUES ('01','Hamburguesa',2.6);
INSERT INTO PRODUCTO VALUES ('02','Patatas',2.0);
INSERT INTO PRODUCTO VALUES ('03','tomate',0.50);
INSERT INTO PRODUCTO VALUES ('04','Queso',1.0);
INSERT INTO PRODUCTO VALUES ('05','Lechuga',0.50);
INSERT INTO PRODUCTO VALUES ('06','Pollo',3.6);
INSERT INTO PRODUCTO VALUES ('08','Bacon',1.5);
INSERT INTO PRODUCTO VALUES ('09','Coca cola',3.0);
INSERT INTO PRODUCTO VALUES ('19','Fanta',3.0);
INSERT INTO PRODUCTO VALUES ('10','Nestea',3.0);
INSERT INTO PRODUCTO VALUES ('18','Agua',2.0);
INSERT INTO PRODUCTO VALUES ('11','Menú de Pollo',5.0);
INSERT INTO PRODUCTO VALUES ('12','Menú de Hamburguesa con queso',6.0);
INSERT INTO PRODUCTO VALUES ('13','Menú de Pollo con queso',6.0);
INSERT INTO PRODUCTO VALUES ('14','Menú de Hamburguesa',6.0);
INSERT INTO PRODUCTO VALUES ('15','Helado',1.0);
INSERT INTO PRODUCTO VALUES ('16','Tarta',2.0);
INSERT INTO PRODUCTO VALUES ('17','Fruta',1.0);


/* VALORES EN TABLA está_compuesto */
/* menu de pollo*/
INSERT INTO esta_compuesto VALUES ('11','06');
INSERT INTO esta_compuesto VALUES ('11','02');
INSERT INTO esta_compuesto VALUES ('11','03');
INSERT INTO esta_compuesto VALUES ('11','18');
INSERT INTO esta_compuesto VALUES ('11','17');
/* menu de hamburguesa con queso*/
INSERT INTO esta_compuesto VALUES ('12','01');
INSERT INTO esta_compuesto VALUES ('12','02');
INSERT INTO esta_compuesto VALUES ('12','04');
INSERT INTO esta_compuesto VALUES ('12','10');
INSERT INTO esta_compuesto VALUES ('12','16');
/* menu de pollo con queso */
INSERT INTO esta_compuesto VALUES ('13','06');
INSERT INTO esta_compuesto VALUES ('13','08');
INSERT INTO esta_compuesto VALUES ('13','04');
INSERT INTO esta_compuesto VALUES ('13','02');
INSERT INTO esta_compuesto VALUES ('13','09');
INSERT INTO esta_compuesto VALUES ('13','15');
/* menu de hamburguesa */
INSERT INTO esta_compuesto VALUES ('14','03');
INSERT INTO esta_compuesto VALUES ('14','05');
INSERT INTO esta_compuesto VALUES ('14','08');
INSERT INTO esta_compuesto VALUES ('14','01');
INSERT INTO esta_compuesto VALUES ('14','02');
INSERT INTO esta_compuesto VALUES ('14','09');
INSERT INTO esta_compuesto VALUES ('14','15');

/* VALORES EN TABLA EMPLEADO */
INSERT INTO EMPLEADO VALUES ('11111111Q','Luis Ramírez Pardo','23445556666' , 'mañana', 900);
INSERT INTO EMPLEADO VALUES ('22222222S','María Sánchez Cid','11112223334' , 'tarde', 1000);
INSERT INTO EMPLEADO VALUES ('33333333M','Martín Guerrero López','33344455566' , 'tarde', 1000);
INSERT INTO EMPLEADO VALUES ('04444444T','Úrsula Delta Camacho', '11177788899', 'mañana', 900);
INSERT INTO EMPLEADO VALUES ('55555555J','Carmen Hernández Pío','99966633311' , 'mañana', 900);
INSERT INTO EMPLEADO VALUES ('77777777M','Pedro Jiménez Ruiz','23456785432' , 'tarde', 1000);
INSERT INTO EMPLEADO VALUES ('99999999X','Raúl Rodrigo Roca','55566677789' , 'tarde', 1000);
INSERT INTO EMPLEADO VALUES ('88888888O','Soledad Campillo Molina','00088877754' , 'noche', 1200);
INSERT INTO EMPLEADO VALUES ('03232323P','María Luisa Galdón Ter','43534534567', 'noche', 1200);
INSERT INTO EMPLEADO VALUES ('14567555L','Piedad Colmenero Zapillo','23456734534' , 'noche', 1200);
INSERT INTO EMPLEADO VALUES ('14111155T','Sergio Lérida Campos','55577700089' , 'tarde', 1000);


/* VALORES EN TABLA REPARTIDOR */
INSERT INTO REPARTIDOR VALUES ('14188151T','Carlos Sánchez Ruíz', 'tarde', 300);
INSERT INTO REPARTIDOR VALUES ('11245621Q','Juan Pardo Rubio', 'noche', 400);
INSERT INTO REPARTIDOR VALUES('04477744T','Laura Jiménez Jiménez', 'noche', 400);
INSERT INTO REPARTIDOR VALUES('51235555J','Carmen Capel Pío', 'tarde', 300);
INSERT INTO REPARTIDOR VALUES('55675675J','Juan Sánchez López', 'mañana', 200);
INSERT INTO REPARTIDOR VALUES('99009900J','Alejandro Pardo López', 'mañana', 400);

/* VALORES EN TABLA PEDIDOS */
INSERT INTO PEDIDO VALUES('0001',16,'11111111Q','04444444T','55675675J',TO_DATE('15/10/2020 12:00','DD-MM-YYYY HH24:MI'),TO_DATE('15/10/2020 12:15','DD-MM-YYYY HH24:MI'),TO_DATE('15/10/2020 12:45','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0002',19,'22222222S','77777777M','99009900J',TO_DATE('11/11/2020 13:30','DD-MM-YYYY HH24:MI'),TO_DATE('11/11/2020 13:45','DD-MM-YYYY HH24:MI'),TO_DATE('11/11/2020 14:05','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0003',13,'77777777M','22222222S','99009900J',TO_DATE('15/10/2020 15:00','DD-MM-YYYY HH24:MI'),TO_DATE('15/10/2020 15:15','DD-MM-YYYY HH24:MI'),TO_DATE('15/10/2020 15:45','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0004',19,'99999999X','77777777M','04477744T',TO_DATE('10/11/2020 14:02','DD-MM-YYYY HH24:MI'),TO_DATE('10/11/2020 14:30','DD-MM-YYYY HH24:MI'),TO_DATE('10/11/2020 14:45','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0005',20,'14567555L','03232323P','14188151T',TO_DATE('05/09/2020 19:02','DD-MM-YYYY HH24:MI'),TO_DATE('05/09/2020 19:30','DD-MM-YYYY HH24:MI'),TO_DATE('05/09/2020 19:45','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0006',23,'14567555L','88888888O','04477744T',TO_DATE('15/11/2020 21:02','DD-MM-YYYY HH24:MI'),TO_DATE('15/11/2020 21:35','DD-MM-YYYY HH24:MI'),TO_DATE('15/11/2020 21:45','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0007',17,'03232323P','88888888O','14188151T',TO_DATE('25/09/2020 23:05','DD-MM-YYYY HH24:MI'),TO_DATE('25/09/2020 23:12','DD-MM-YYYY HH24:MI'),TO_DATE('25/09/2020 23:35','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0008',17,'99999999X','33333333M','11245621Q',TO_DATE('15/09/2020 18:02','DD-MM-YYYY HH24:MI'),TO_DATE('15/09/2020 18:30','DD-MM-YYYY HH24:MI'),TO_DATE('15/09/2020 18:35','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0009',25,'04444444T','55555555J','99009900J',TO_DATE('23/11/2020 11:02','DD-MM-YYYY HH24:MI'),TO_DATE('23/11/2020 11:30','DD-MM-YYYY HH24:MI'),TO_DATE('23/11/2020 11:55','DD-MM-YYYY HH24:MI'));
INSERT INTO PEDIDO VALUES('0010',45,'88888888O','14567555L',null,TO_DATE('05/11/2020 22:05','DD-MM-YYYY HH24:MI'),TO_DATE('05/11/2020 22:12','DD-MM-YYYY HH24:MI'),null);
INSERT INTO PEDIDO VALUES('0011',14.2,'88888888O','14567555L',null,TO_DATE('05/11/2020 22:05','DD-MM-YYYY HH24:MI'),null,null);

/* VALORES EN TABLA consta */
INSERT INTO consta VALUES ('11','0001',2);
INSERT INTO consta VALUES ('12','0001',1);
INSERT INTO consta VALUES ('11','0002',1);
INSERT INTO consta VALUES ('12','0002',2);
INSERT INTO consta VALUES ('15','0002',2);
INSERT INTO consta VALUES ('14','0003',2);
INSERT INTO consta VALUES ('17','0003',1);
INSERT INTO consta VALUES ('13','0004',3);
INSERT INTO consta VALUES ('04','0004',1);
INSERT INTO consta VALUES ('13','0005',2);
INSERT INTO consta VALUES ('12','0005',1);
INSERT INTO consta VALUES ('02','0005',1);
INSERT INTO consta VALUES ('12','0006',2);
INSERT INTO consta VALUES ('13','0006',1);
INSERT INTO consta VALUES ('19','0006',1);
INSERT INTO consta VALUES ('18','0006',1);
INSERT INTO consta VALUES ('12','0007',2);
INSERT INTO consta VALUES ('09','0007',1);
INSERT INTO consta VALUES ('02','0007',1);
INSERT INTO consta VALUES ('13','0008',2);
INSERT INTO consta VALUES ('11','0008',1);
INSERT INTO consta VALUES ('13','0009',4);
INSERT INTO consta VALUES ('15','0009',1);
INSERT INTO consta VALUES ('12','0010',3);
INSERT INTO consta VALUES ('13','0010',3);
INSERT INTO consta VALUES ('16','0010',3);
INSERT INTO consta VALUES ('04','0010',3);
INSERT INTO consta VALUES ('01','0011',2);
INSERT INTO consta VALUES ('09','0011',1);
INSERT INTO consta VALUES ('18','0011',2);
INSERT INTO consta VALUES ('15','0011',2);

-- 1
CREATE OR REPLACE PROCEDURE EJ1(NUMPED VARCHAR)
AS
CURSOR CEJ1 IS SELECT CODIGO, NOMBRE, PRECIO, (PRECIO * CANTIDAD) AS TOT  FROM PRODUCTO
    INNER JOIN CONSTA ON CODIGO_PR = CODIGO INNER JOIN PEDIDO ON NUMERO = NUMERO_P
    WHERE NUMERO = NUMPED;

REGEJ1 CEJ1%ROWTYPE;
TOTAL NUMBER;
BEGIN
TOTAL := 0;
OPEN CEJ1;
FETCH CEJ1 INTO REGEJ1;
WHILE CEJ1%FOUND LOOP
    DBMS_OUTPUT.PUT_LINE(REGEJ1.CODIGO||' '|| REGEJ1.NOMBRE||' '|| REGEJ1.PRECIO||' '|| REGEJ1.TOT);
    TOTAL := TOTAL + REGEJ1.TOT;
    FETCH CEJ1 INTO REGEJ1;
END LOOP;
CLOSE CEJ1;
DBMS_OUTPUT.PUT_LINE(TOTAL);
END EJ1;

-- 2
CREATE OR REPLACE PROCEDURE EJ2(DOC VARCHAR)
AS
CANT_NOT NUMBER;
CANT_PED NUMBER;
NOM VARCHAR(30);
SAL NUMBER;
INCREMENTO NUMBER;
BEGIN
SELECT COUNT(*) INTO CANT_NOT FROM PEDIDO WHERE DNI_ETM = DOC;
SELECT COUNT(*) INTO CANT_PED FROM PEDIDO WHERE DNI_EP = DOC;
INCREMENTO := CANT_NOT * 10 + CANT_PED * 15;
UPDATE EMPLEADO SET SALARIO = SALARIO + INCREMENTO WHERE DOC = DNI;
SELECT NOMBRE INTO NOM FROM EMPLEADO WHERE DNI = DOC;
SELECT SALARIO INTO SAL FROM EMPLEADO WHERE DNI = DOC;
DBMS_OUTPUT.PUT_LINE('NOMBRE: '||NOM||' TOMO NOTA: '||CANT_NOT||' PREPARO: '||CANT_PED|| ' SALARIO NUEVO: '||SAL);
END EJ2;

-- 3
CREATE OR REPLACE FUNCTION EJ3(NOM VARCHAR)
RETURN NUMBER
AS
CANT NUMBER;
BEGIN 
SELECT COUNT(*) INTO CANT FROM PEDIDO INNER JOIN REPARTIDOR ON DNI_R = DNI WHERE
    NOMBRE = NOM;
RETURN CANT;
END EJ3;


-- 4
CREATE OR REPLACE TRIGGER EJ4 AFTER INSERT OR UPDATE ON PEDIDO
FOR EACH ROW
BEGIN
IF :OLD.HORA_REP IS NULL THEN
    UPDATE REPARTIDOR SET INCENTIVO = INCENTIVO + 10 WHERE :NEW.DNI_R = DNI;
END IF;
END EJ4;

-- 5
CREATE OR REPLACE PROCEDURE EJ5(NOM VARCHAR)
AS
CURSOR CEJ5 IS SELECT NUMERO, HORA_TM, IMPORTE FROM PEDIDO
    INNER JOIN EMPLEADO ON DNI = DNI_ETM WHERE NOMBRE = NOM;
REGEJ5 CEJ5%ROWTYPE;
CANT NUMBER;
TOT NUMBER;
BEGIN 
OPEN CEJ5;
FETCH CEJ5 INTO REGEJ5;
DBMS_OUTPUT.PUT_LINE(RPAD('NUMERO',6)||RPAD('FECHA',15)||'IMPORTE');
CANT := 0;
TOT := 0;
WHILE CEJ5%FOUND LOOP
    DBMS_OUTPUT.PUT_LINE(RPAD(REGEJ5.NUMERO,6)||RPAD(REGEJ5.HORA_TM,15)||REGEJ5.IMPORTE);
    CANT := CANT + 1;
    TOT := TOT + REGEJ5.IMPORTE;
    FETCH CEJ5 INTO REGEJ5;
END LOOP;
DBMS_OUTPUT.PUT_LINE('CANTIDAD DE PEDIDOS: '||CANT||' IMPORTE TOTAL: '||TOT);
CLOSE CEJ5;
END EJ5;

-- 6
CREATE OR REPLACE FUNCTION EJ6(COD VARCHAR) RETURN NUMBER
AS 
CANT NUMBER;
NOM VARCHAR(30);
BEGIN
SELECT NOMBRE INTO NOM FROM PRODUCTO WHERE CODIGO = COD;
SELECT COUNT(*) INTO CANT FROM CONSTA WHERE CODIGO_PR = COD;
RETURN CANT;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('NO EXISTE EL PRODUCTO');
        
END EJ6;

-- 7
CREATE OR REPLACE PROCEDURE EJ7(NOM VARCHAR)
AS
CANT NUMBER;
V_PRECIO NUMBER;
N_PRECIO NUMBER;
BEGIN
SELECT PRECIO INTO V_PRECIO FROM PRODUCTO WHERE NOMBRE = NOM;
SELECT COUNT(*) INTO CANT FROM PRODUCTO WHERE NOMBRE = NOM;
IF CANT < 5 THEN
    N_PRECIO := V_PRECIO * 1.05;
ELSIF CANT <= 10 THEN
    N_PRECIO := V_PRECIO * 1.1;
ELSE
    N_PRECIO := V_PRECIO * 1.15;
END IF;
DBMS_OUTPUT.PUT_LINE('El producto '||NOM|| 'con precio '||V_PRECIO||' ahora cuesta '||N_PRECIO);
UPDATE PRODUCTO SET PRECIO = N_PRECIO WHERE NOMBRE = NOM;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('EL PRODUCTO NO EXISTE');
END;

-- 8
ALTER TABLE PRODUCTO ADD  STOCK INT DEFAULT 100;
